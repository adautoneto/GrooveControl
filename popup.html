<link rel="stylesheet" href="popup.css" />
<script type="text/javascript" src="lib/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="tabs.js"></script>
<script type="text/javascript">

  var PopupView = function(port) {
    function playing(song, artist, art) {
      $("#song").text(song);
      $("#artist").text(artist);

      if (art == null) art = "imgs/90_album.png";
      $("#album-art img").attr("src", art);
    }

    function controls(html) {
      $("#player-controls").html(html);

      $("button").click(function() {
        port.postMessage( {action: "clickControl", controlId: this.id} );
      });
    }

    function getContentInfo() {
      console.log('get content info');
      port.postMessage( { action: "getContent" });
    }

    return {
      getContentInfo: getContentInfo,
      render: function(nowPlaying) {
        console.log('render');
	nowPlaying.isEmptyQueue ? playing("No current songs", "", null) :
        playing(nowPlaying.song, nowPlaying.artist, nowPlaying.album);
        controls(nowPlaying.controls);
        //setTimeout(getContentInfo, 10000);
      }
    }
  }

  $(chrome.windows).on("tabFound", function(event, tabId) {
    console.log('tab found');
    var port = chrome.tabs.connect(tabId); console.log('tab connect');
    
    var popupView = new PopupView(port); console.log('new Popup');
    popupView.getContentInfo(); console.log('popupView.get Content Info');

    port.onMessage.addListener(function(msg) {
	console.log('onMessage triggered ', msg, port);
      switch(msg.action) {
        case "renderPopup":
	  console.log('render popup from popup');
          var nowPlaying = msg.data;
          popupView.render(nowPlaying);
          break;
      }
    });
  });

</script>

<div id="playing">
  <div id="album-art"><img src="imgs/90_album.png" /></div>
  <div id="current-song">
    <div id="song"></div>
    <div id="artist"></div>
  </div>
  <div id="player-controls"></div>
<div>
