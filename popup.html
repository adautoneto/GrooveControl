<style>
	body { width: 395px; }
	#title { background: url('title-bg.png') repeat-x; text-align: center; }
	a { color: #fff; }
	#username { text-align:center; color: blue; margin-bottom: 10px; }
	#playing { font: 10pt Candara, Tahoma; padding: 0 10px; color: #fff; overflow: hidden; height: 72px; line-height: 72px; background: url('middle-bg.png') no-repeat; text-overflow: ellipsis; white-space: nowrap; }
	#player-controls { text-align: center; margin: 0 auto; height: 40px; background: url('controls-bg.png') repeat-x; }
	button { cursor: pointer; border: none; width: 32px; height: 32px; background: url('controls.png'); }
	.player_control:hover button {background-position: -40px 0;}
	.player_control:active button {background-position: -80px 0;}
	#player_play_pause[disabled="disabled"], #player_play_pause.disabled {background-position: 0 0;}
	#player_play_pause[disabled="disabled"]:hover, #player_play_pause.disabled:hover {background-position: 0 0;}
	#player_play_pause[disabled="disabled"]:active, #player_play_pause.disabled:active {background-position: 0 0;}
	#player_play_pause{background-position: -40px 0;}
	#player_play_pause:hover {background-position: -80px 0;}
	#player_play_pause:active {background-position: -120px 0;}	
	#player_play_pause.pause {background-position: -40px -40px;}
	#player_play_pause.pause:hover {background-position: -80px -40px;}
	#player_play_pause.pause:active {background-position: -120px -40px;}
	#player_play_pause.buffering { background: url(loading.gif) top left no-repeat; padding:0; background-position: 8px 8px;}
	#player_previous[disabled="disabled"], #player_previous.disabled {background-position: -5px -80px;}
	#player_previous[disabled="disabled"]:hover, #player_previous.disabled:hover {background-position: -5px -80px;}
	#player_previous[disabled="disabled"]:active, #player_previous.disabled:active {background-position: -5px -80px;}
	#player_previous {background-position: -45px -80px; width: 30px;}
	#player_previous:hover {background-position: -85px -80px;}
	#player_previous:active {background-position: -125px -80px;}
	#player_next[disabled="disabled"], #player_next.disabled {background-position: -5px -120px;}
	#player_next[disabled="disabled"]:hover, #player_next.disabled:hover {background-position: -5px -120px;}
	#player_next[disabled="disabled"]:active, #player_next.disabled:active {background-position: -5px -120px;}
	#player_next {background-position: -45px -120px; width: 30px;}
	#player_next:hover {background-position: -85px -120px;}
	#player_next:active {background-position: -125px -120px;}
</style>

<script type="text/javascript" src="jquery-1.6.2.min.js"></script>
<script>	
	chrome.windows.getAll({populate: true}, function(windows){				
		var tab = null;
		
		for(var w in windows) {
			var tabs = windows[w].tabs;
			for (var t in tabs) {
				if (tabs[t].title.match(/grooveshark/i)) {
					tab = tabs[t];
				}
			}
		}							
		
		if (tab == null)
			chrome.tabs.create({url: "http://grooveshark.com/"}, function(tab){
				insertScripts(tab.id);
			});
		else {
			insertScripts(tab.id);
		}
	});	
	
	chrome.extension.onConnect.addListener(function(port) {		
		var tab = port.sender.tab;

		// This will get called by the content script we execute in
		// the tab as a result of the user pressing the browser action.
		port.onMessage.addListener(function(msg) {							 
			switch(msg.action) {
				case "setSong":
					setSong(port, msg.data);
					break;
				case "setControls":
					setControls(port, msg.data);
					break;
			}
		});			
	});

	function insertScripts(tabId){
		chrome.tabs.executeScript(tabId, {file: "jquery-1.6.2.min.js"});
		chrome.tabs.executeScript(tabId, {file: "content_script.js"});
	}
	  
	function setSong(port, info){		
		if (info == null)
		{
			noSongPlaying();
			return;
		}
						
		$("#playing").text(info.playing.song + " - " + info.playing.artist + " - " + info.playing.album);		  				
	}
	
	function setControls(port, info){
		$("#player-controls").html(info);
		
		$("button").click(function() {			
			console.log(this.id);
			port.postMessage( {action: "clickControl", controlId: this.id} );			
		});
		
		setTimeout(function(){ port.postMessage( {action: "getControls"} ); }, 500);
	}
	
	function noSongPlaying(){
		$("#playing").text("No song currently playing");
	}	
</script>

<div id="title"><img src="title.png" /></div>
<div id="playing">Loading...</div>
<div id="player-controls"></div>